<!DOCTYPE html>
<html>
	<head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
	<meta charset="utf-8">
	<title>Bike The Beach Route Builder</title>
	<style>
	html, body, #map
	{
		height: 100%;
		margin: 0px;
		padding: 0px
	}

	#panel
	{
		position: absolute;
		top: 5px;
		left: 50%;
		margin-left: -180px;
		z-index: 5;
		background-color: #fff;
		padding: 5px;
		border: 1px solid #999;
	}

	#bar
	{
		width: 240px;
		background-color: rgba(255, 255, 255, 0.75);
		margin: 8px;
		padding: 4px;
		border-radius: 4px;
	}

	#autoc
	{
		width: 100%;
		box-sizing: border-box;
	}
	</style>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?libraries=drawing,places"></script>
	<script>
	var apiKey = 'AIzaSyBUyIV-JfLai3CEzPCOIRmWrfZU8-c4hm4';

	var map;
	var markers = [];
	var snappedPolyline;
	

	function initialize()
	{
		var mapOptions =
		{
			zoom: 17,
			center: {lat: 41.143353, lng: -73.236580},
			streetViewControl : false,
			mapTypeControl : false,
			styles : [{featureType : "poi", elementType : "labels", stylers : [{visibility : "off"}]}]
		};
		map = new google.maps.Map(document.getElementById('map'), mapOptions);
		
		map.addListener('click', addMarker);
		snappedPolyline = new google.maps.Polyline({strokeColor: 'blue', strokeWeight: 5, map : map, strokeOpacity : 0.5});
		snappedPolyline.addListener('click', insertMarker);
		
		
	}
	
	// Call Snap To Road API
	function runSnapToRoad()
	{
		// Clear polylines first
		for(var i = 0; i < markers.length; i ++)
		{
			if(markers[i].polyline)
				markers[i].polyline.setMap(null);
		}

		var pathValues = [];
		for (var i = 0; i < markers.length; i++)
		{
			pathValues.push(markers[i].position.lat() + "," + markers[i].position.lng());
		}
		$.get('https://roads.googleapis.com/v1/snapToRoads',
		{
			interpolate: true,
			key: apiKey,
			path: pathValues.join('|')
		},
		function(data)
		{
			processSnapToRoadResponse(data);
		});
	}

	// Store snapped polyline returned by the snap-to-road method.
	function processSnapToRoadResponse(data)
	{
		var snappedCoordinates = [];
		for (var i = 0; i < data.snappedPoints.length; i++)
		{
			var latlng = new google.maps.LatLng(
			data.snappedPoints[i].location.latitude,
			data.snappedPoints[i].location.longitude);
			
			if(data.snappedPoints[i].originalIndex)
			{
				markers[data.snappedPoints[i].originalIndex].setPosition(latlng);
			}
			
			snappedCoordinates.push(latlng);
		}
		snappedPolyline.setPath(snappedCoordinates);
	}

	// Drag Marker
	function dragMarker(event)
	{
		runSnapToRoad();
	}

	// Remove Marker
	function removeMarker(event)
	{
		var idx = markers.indexOf(this);
		var removed = markers.splice(idx, 1);
		removed[0].setMap(null);
		runSnapToRoad();
	}

	// Add marker
	function addMarker(event)
	{
		var markerTmp = new google.maps.Marker({position : event.latLng, map : map, draggable : true});

		markerTmp.addListener('dragend', dragMarker);
		markerTmp.addListener('click', removeMarker);

		markers.push(markerTmp);

		runSnapToRoad();
	}
	
	// Add Midpoint Marker
	function insertMarker(event)
	{
		var distances = [];
		// Convenience Declaration
		var dist = google.maps.geometry.spherical.computeDistanceBetween;
		for(var i = 0; i < markers.length - 1; i ++)
		{
			distances.push(
			{
				index : i,
				value : dist(event.latLng, markers[i].getPosition()) + dist(event.latLng, markers[i + 1].getPosition())
			});
		}
		// Determine where in the array to place the new marker
		distances.sort(function(a, b){return a.value > b.value});
		
		// Add the new marker
		var markerTmp = new google.maps.Marker({position : event.latLng, map : map, draggable : true});
		markerTmp.addListener('dragend', dragMarker);
		markerTmp.addListener('click', removeMarker);
		markers.splice(distances[0].index + 1, 0, markerTmp);
		runSnapToRoad();
	}
	
	$(window).load(initialize);
	</script>
	</head>

	<body>
	<div id="map"></div>
	<div id="bar">
	<p class="auto"><input type="text" id="autoc"/></p>
	<p><a id="clear" href="#">Click here</a> to clear map.</p>
	</div>
	</body>
</html>