

<!DOCTYPE html>
<html>
	<head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
	<meta charset="utf-8">
	<title>Roads API Demo</title>
	<style>
	html, body, #map
	{
		height: 100%;
		margin: 0px;
		padding: 0px
	}

	#panel
	{
		position: absolute;
		top: 5px;
		left: 50%;
		margin-left: -180px;
		z-index: 5;
		background-color: #fff;
		padding: 5px;
		border: 1px solid #999;
	}

	#bar
	{
		width: 240px;
		background-color: rgba(255, 255, 255, 0.75);
		margin: 8px;
		padding: 4px;
		border-radius: 4px;
	}

	#autoc
	{
		width: 100%;
		box-sizing: border-box;
	}
	</style>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?libraries=drawing,places"></script>
	<script>
	var apiKey = 'AIzaSyBUyIV-JfLai3CEzPCOIRmWrfZU8-c4hm4';

	var map;
	var placeIdArray = [];
	var snappedCoordinates = [];

	var markers = [];

	function initialize()
	{
		var mapOptions = { zoom: 17, center: {lat: 41.143353, lng: -73.236580} };
		map = new google.maps.Map(document.getElementById('map'), mapOptions);

		// Adds a Places search box. Searching for a place will center the map on that
		// location.
		map.controls[google.maps.ControlPosition.RIGHT_TOP].push(document.getElementById('bar'));
		var autocomplete = new google.maps.places.Autocomplete(document.getElementById('autoc'));
		autocomplete.bindTo('bounds', map);
		autocomplete.addListener('place_changed',
		function()
		{
		var place = autocomplete.getPlace();
		if (place.geometry.viewport)
		{
			map.fitBounds(place.geometry.viewport);
		}
		else
		{
			map.setCenter(place.geometry.location);
			map.setZoom(17);
		}
		});

		map.addListener('click', addMarker);

		// Clear button. Click to remove all polylines.
		$('#clear').click(function(ev)
		{
			for (var i = 0; i < markers.length; i ++)
			{
			markers[i].setMap(null);
			}
			markers = [];
			return false;
		});
	}

	function runSnapToRoad(marker)
	{
		// Clear polylines first
		for(var i = 0; i < markers.length; i ++)
		{
			if(markers[i].polyline)
				markers[i].polyline.setMap(null);
		}

		var pathValues = [];
		for (var i = 0; i < markers.length; i++)
		{
			pathValues.push(markers[i].position.lat() + "," + markers[i].position.lng());
		}
		$.get('https://roads.googleapis.com/v1/snapToRoads',
		{
			interpolate: true,
			key: apiKey,
			path: pathValues.join('|')
		},
		function(data)
		{
			processSnapToRoadResponse(data);
			drawSnappedPolyline(marker);
		});
	}

	// Drag Marker
	function dragMarker(event)
	{
		runSnapToRoad(this);
	}

	// Remove Marker
	function removeMarker(event)
	{
		var idx = markers.indexOf(this);
		var removed = markers.splice(idx, 1);
		removed[0].setMap(null);

		console.log(markers);
	}

	// Add marker
	function addMarker(event)
	{
		var markerTmp = new google.maps.Marker({position : event.latLng, map : map, draggable : true});

		google.maps.event.addListener(markerTmp, 'dragend', dragMarker);
		google.maps.event.addListener(markerTmp, 'click', removeMarker);

		markers.push(markerTmp);

		runSnapToRoad(markerTmp);
	}

	// Store snapped polyline returned by the snap-to-road method.
	function processSnapToRoadResponse(data)
	{
		snappedCoordinates = [];
		placeIdArray = [];
		for (var i = 0; i < data.snappedPoints.length; i++)
		{
			var latlng = new google.maps.LatLng(
			data.snappedPoints[i].location.latitude,
			data.snappedPoints[i].location.longitude);
			snappedCoordinates.push(latlng);
			placeIdArray.push(data.snappedPoints[i].placeId);
		}
	}

	// Draws the snapped polyline (after processing snap-to-road response).
	function drawSnappedPolyline(marker)
	{
		var snappedPolyline = new google.maps.Polyline({path: snappedCoordinates, strokeColor: 'black', strokeWeight: 3});
		marker.polyline = snappedPolyline;
		marker.polyline.setMap(map);
	}
	$(window).load(initialize);
	</script>
	</head>

	<body>
	<div id="map"></div>
	<div id="bar">
	<p class="auto"><input type="text" id="autoc"/></p>
	<p><a id="clear" href="#">Click here</a> to clear map.</p>
	</div>
	</body>
</html>